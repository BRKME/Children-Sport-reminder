#!/usr/bin/env python3
"""
Kids Schedule Analyzer with Telegram notifications
Simplified version for GitHub Actions
"""

import asyncio
import aiohttp
import json
from datetime import datetime
import locale

class UniswapAnalyzer:
    def __init__(self):
        # Telegram settings
        self.telegram_token = "8442392037:AAEiM_b4QfdFLqbmmc1PXNvA99yxmFVLEp8"
        self.chat_id = "350766421"
        
        # Daily parenting tips
        self.parenting_tips = {
            'marta_girl': {
                'title': '–ú–∞—Ä—Ç–∞ (9 –ª–µ—Ç)',
                'tips': [
                    "–ü–æ–∫–∞–∂–∏, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –∑–∞ –Ω–µ—ë, —Å–ª—É—à–∞–π –±–µ–∑ –ª–µ–∫—Ü–∏–π –∏ —Ä–∞–∑–±–∏—Ä–∞–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ.",
                    "–ù–µ —á–∏—Ç–∞–π –º–æ—Ä–∞–ª–∏ ('—è –∂–µ –≥–æ–≤–æ—Ä–∏–ª') –∏ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π —É—Å–ø–µ—Ö–∏ ‚Äî –æ—Ç–º–µ—á–∞–π –¥–∞–∂–µ –º–µ–ª–æ—á–∏.",
                    "–°–ª—É—à–∞–π –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è ‚Äî —ç—Ç–æ —Å—Ç—Ä–æ–∏—Ç —Å–≤—è–∑—å. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π —Ç–µ–º—ã —Ç–µ–ª–∞ –∏ –≤–∑—Ä–æ—Å–ª–µ–Ω–∏—è.",
                    "–î–∞–π –∑–æ–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–∫–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏, –≤—ã–±–æ—Ä –æ–¥–µ–∂–¥—ã), –Ω–æ –Ω–µ –≥—Ä—É–∑–∏ –≤–∑—Ä–æ—Å–ª—ã–º.",
                    "–•–≤–∞–ª–∏ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å ('—Ç—ã —Å—Ç–∞—Ä–∞–ª–∞—Å—å'), –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
                    "–ò–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è —Ç–∞–Ω—Ü–∞–º–∏, –∫–Ω–∏–≥–∞–º–∏, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π –º–Ω–µ–Ω–∏–µ, –ø–æ–¥–∫–∏–¥—ã–≤–∞–π —Ä–µ—Å—É—Ä—Å—ã.",
                    "–ü–æ–º–æ–≥–∞–π –Ω–∞–π—Ç–∏ —Å–≤–æ–π —Å—Ç–∏–ª—å —É—á—ë–±—ã, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ü–µ–Ω–∫–∞—Ö.",
                    "–°–ª–µ–¥–∏ –∑–∞ –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º –ø–æ–¥—Ä—É–∂–µ–∫ ‚Äî –¥–ª—è –Ω–µ—ë —ç—Ç–æ –∫–∞–∫ –≤—Å–µ–ª–µ–Ω–Ω–∞—è.",
                    "–ü–æ–æ—â—Ä—è–π —Å–ø–æ—Ä—Ç, –¥–≤–∏–∂–µ–Ω–∏–µ, –∏–≥—Ä—ã ‚Äî –º–æ–∑–≥ –∏ —Ç–µ–ª–æ —Å–≤—è–∑–∞–Ω—ã.",
                    "–®—É—Ç–∏—Ç–µ –≤–º–µ—Å—Ç–µ, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–µ–º–µ–π–Ω—ã–µ –º–µ–º—ã ‚Äî —ç—Ç–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è.",
                    "–ù–∞—É—á–∏ —Ä–µ—à–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ —Å–≤–µ—Ä—Å—Ç–Ω–∏—Ü–∞–º–∏ ‚Äî –ø–æ–º–æ–≥–∞–π –≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è.",
                    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π –µ—ë —Å –¥—Ä—É–≥–∏–º–∏ –¥–µ—Ç—å–º–∏ ‚Äî –∫–∞–∂–¥–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–∞ –≤ —Å–≤–æ—ë–º —Ä–∞–∑–≤–∏—Ç–∏–∏.",
                    "–£—Å—Ç–∞–Ω–æ–≤–∏ –∑–¥–æ—Ä–æ–≤—ã–π —Ä–µ–∂–∏–º —Å–Ω–∞ (9 —á–∞—Å–æ–≤ –≤ –Ω–æ—á—å) ‚Äî —É—Å—Ç–∞–ª–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ —ç–º–æ—Ü–∏–∏.",
                    "–ì–æ–≤–æ—Ä–∏ –æ —á—É–≤—Å—Ç–≤–∞—Ö: '—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∑–ª–∏—Ç—å—Å—è, –≥—Ä—É—Å—Ç–∏—Ç—å, –±–æ—è—Ç—å—Å—è' ‚Äî –Ω–∞–∑–æ–≤–∏ —ç–º–æ—Ü–∏–∏.",
                    "–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —ç–∫—Ä–∞–Ω—ã –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ —Å–Ω–æ–º –∏ —Ñ–æ–∫—É—Å–æ–º.",
                    "–°–æ–∑–¥–∞–≤–∞–π —Å–µ–º–µ–π–Ω—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ (—Å–µ–º–µ–π–Ω—ã–π —É–∂–∏–Ω, –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å) ‚Äî —ç—Ç–æ —è–∫–æ—Ä—è."
                ]
            },
            'arkasha_boy': {
                'title': '–ê—Ä–∫–∞—à–∞ (13 –ª–µ—Ç)',
                'tips': [
                    "–°–æ—Ö—Ä–∞–Ω–∏ –¥–æ–≤–µ—Ä–∏–µ –≤ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ ‚Äî –±—É–¥—å –≥–µ—Ä–æ–µ–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç, –∞ –Ω–µ —Å—É–¥–∏—Ç.",
                    "–ò–∑–±–µ–≥–∞–π —Å—Ç—ë–±–∞ –∏ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º ('—Ñ–∏–≥–Ω—è, —Å –¥—Ä—É–∑—å—è–º–∏ –ø–æ—Å—Å–æ—Ä–∏–ª—Å—è').",
                    "–°–ª—É—à–∞–π –∞–∫—Ç–∏–≤–Ω–æ, –æ–±—Å—É–∂–¥–∞–π –ø–æ –¥—É—à–∞–º, –æ—Å–æ–±–µ–Ω–Ω–æ –æ —á—É–≤—Å—Ç–≤–∞—Ö –∏ –≤—ã–∑–æ–≤–∞—Ö ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ.",
                    "–ù–µ —á–∏—Ç–∞–π –º–æ—Ä–∞–ª–∏ –∏ –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –º–Ω–µ–Ω–∏—è ‚Äî —Ä–∞–∑–±–∏—Ä–∞–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ.",
                    "–ì–æ–≤–æ—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ –æ —Ç–µ–ª–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏ —Å–µ–∫—Å–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—ã–¥–∞.",
                    "–î–∞–π –±–æ–ª—å—à–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–±—é–¥–∂–µ—Ç, –≤—ã–±–æ—Ä —Ö–æ–±–±–∏), –Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π —á—ë—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞.",
                    "–•–≤–∞–ª–∏ –∑–∞ —É—Å–∏–ª–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.",
                    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å –¥—Ä—É–≥–∏–º–∏ ‚Äî —ç—Ç–æ —Ä–∞–∑—Ä—É—à–∞–µ—Ç —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É.",
                    "–ò–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è –∏–≥—Ä–∞–º–∏, —Å–ø–æ—Ä—Ç–æ–º, –≥–∞–¥–∂–µ—Ç–∞–º–∏ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π –º–Ω–µ–Ω–∏–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π —Ä–µ—Å—É—Ä—Å—ã.",
                    "–°–ª–µ–¥–∏ –∑–∞ –∫–æ–º–ø–∞–Ω–∏–µ–π, –Ω–æ –¥–∞–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ ‚Äî –¥—Ä—É–∑—å—è –¥–ª—è –Ω–µ–≥–æ –∫–∞–∫ –≤—Ç–æ—Ä–∞—è —Å–µ–º—å—è.",
                    "–û–±—Å—É–∂–¥–∞–π —Ä–∏—Å–∫–∏ (–∫—É—Ä–µ–Ω–∏–µ, –∞–ª–∫–æ–≥–æ–ª—å) –æ—Ç–∫—Ä—ã—Ç–æ –∏ –ø–æ–æ—â—Ä—è–π –∑–¥–æ—Ä–æ–≤—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.",
                    "–ü–æ–æ—â—Ä—è–π —Å–ø–æ—Ä—Ç –∏ –¥–≤–∏–∂–µ–Ω–∏–µ ‚Äî –≤ 13 –ª–µ—Ç —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å —ç–Ω–µ—Ä–≥–∏–µ–π –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é.",
                    "–®—É—Ç–∏—Ç–µ –≤–º–µ—Å—Ç–µ, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–µ–º–µ–π–Ω—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ —É–∫—Ä–µ–ø–ª—è–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è.",
                    "–ò–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è –µ–≥–æ —Ü–µ–ª—è–º–∏ –∏ –º–µ—á—Ç–∞–º–∏ ‚Äî –ø–æ–º–æ–≥–∞–π –≤–∏–¥–µ—Ç—å –ø—É—Ç—å –∫ –Ω–∏–º.",
                    "–ü—Ä–∏–∑–Ω–∞–≤–∞–π –µ–≥–æ —Ä–∞—Å—Ç—É—â—É—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –Ω–æ –±—É–¥—å —è—Å–µ–Ω —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏.",
                    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π '–≤—Å–µ —Ä–æ–≤–µ—Å–Ω–∏–∫–∏ —ç—Ç–æ –¥–µ–ª–∞—é—Ç' –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –ø—Ä–æ—Ç–∏–≤ ‚Äî —Å–ª—É—à–∞–π –µ–≥–æ –ª–æ–≥–∏–∫—É.",
                    "–ü–æ–º–æ–≥–∞–π —É–ø—Ä–∞–≤–ª—è—Ç—å –≥–Ω–µ–≤–æ–º –∏ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ–º ‚Äî —É—á–∏ –∑–¥–æ—Ä–æ–≤—ã–º –≤—ã—Ö–æ–¥–∞–º (—Å–ø–æ—Ä—Ç, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ).",
                    "–ì–æ–≤–æ—Ä–∏ –æ –¥–∞–≤–ª–µ–Ω–∏–∏ —Å–≤–µ—Ä—Å—Ç–Ω–∏–∫–æ–≤, –±—É–ª–ª–∏–Ω–≥–µ, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ ‚Äî —Å–æ–∑–¥–∞–≤–∞–π –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.",
                    "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –µ–≥–æ –ª–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å ‚Äî –Ω–æ –∑–Ω–∞–π –æ—Å–Ω–æ–≤–Ω–æ–µ.",
                    "–£—á–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º—É –º—ã—à–ª–µ–Ω–∏—é ‚Äî –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –≤–µ—Ä—É, –≤–æ–ø—Ä–æ—à–∞—Ç—å '–ø–æ—á–µ–º—É'."
                ]
            }
        }
        
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'application/json'
        }
    
    def get_formatted_date(self):
        """Get formatted date string in Russian format"""
        now = datetime.now()
        
        # Russian day names
        days = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']
        months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                  '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è']
        
        day_name = days[now.weekday()]
        day = now.day
        month = months[now.month - 1]
        week_number = now.isocalendar()[1]
        
        return f"{day_name} {day} {month}, –Ω–µ–¥–µ–ª—è {week_number}"
    
    def get_daily_tips(self):
        """Get daily parenting tips"""
        tips_list = []
        for child_key, child_data in self.parenting_tips.items():
            tip = child_data['tips'][datetime.now().day % len(child_data['tips'])]
            tips_list.append({
                'name': child_data['title'],
                'tip': tip
            })
        return tips_list
    
    async def send_telegram_message(self, message: str):
        """Send message to Telegram"""
        try:
            url = f"https://api.telegram.org/bot{self.telegram_token}/sendMessage"
            payload = {
                'chat_id': self.chat_id,
                'text': message,
                'parse_mode': 'HTML',
                'disable_web_page_preview': True
            }
            
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload) as response:
                    if response.status == 200:
                        print("‚úÖ Telegram message sent successfully")
                        return True
                    else:
                        error_text = await response.text()
                        print(f"‚ùå Telegram API error: {error_text}")
                        return False
        except Exception as e:
            print(f"‚ùå Failed to send Telegram message: {e}")
            return False
    
    async def send_schedule_to_telegram(self):
        """Send formatted schedule and tips to Telegram"""
        formatted_date = self.get_formatted_date()
        daily_tips = self.get_daily_tips()
        
        message = f"#–î–µ—Ç–∏ #–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
        message += f"{formatted_date}\n\n"
        message += f"üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–≥–æ–¥–Ω—è —É –¥–µ—Ç–µ–π:\n\n"
        
        # Add daily tips for each child
        for tip_data in daily_tips:
            message += f"<b>{tip_data['name']}</b>\n"
            message += f"üí° {tip_data['tip']}\n\n"
        
        message += "=" * 40 + "\n"
        message += "üìå <b>–°–æ–≤–µ—Ç –¥–Ω—è:</b>\n"
        message += "–°–ª—É—à–∞–π, –Ω–µ –æ—Å—É–∂–¥–∞—è. –î–æ–≤–µ—Ä–∏–µ ‚Äî –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ.\n\n"
        message += "‚ö° <i>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç–µ–ª—å –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è</i>"
        
        await self.send_telegram_message(message)
    
    async def run_analysis(self):
        """Main analysis function"""
        print("üîß Kids Schedule Analyzer")
        print("=" * 50)
        formatted_date = self.get_formatted_date()
        print(f"üìÖ {formatted_date}")
        print("=" * 50)
        
        # Send schedule to Telegram
        print("\nüì± Sending schedule to Telegram...")
        await self.send_schedule_to_telegram()
        
        print(f"‚úÖ Schedule sent!")

async def main():
    """Main execution function"""
    try:
        analyzer = UniswapAnalyzer()
        await analyzer.run_analysis()
    except Exception as e:
        print(f"‚ùå Critical error: {e}")
        # Try to send error to Telegram
        try:
            analyzer = UniswapAnalyzer()
            await analyzer.send_telegram_message(f"‚ùå <b>Schedule Failed</b>\n{str(e)}")
        except:
            pass

if __name__ == "__main__":
    asyncio.run(main())
